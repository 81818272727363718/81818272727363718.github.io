<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shape and Beats - Enemy Pellets</title>
<style>
  body, html { margin:0; padding:0; overflow:hidden;
    background: linear-gradient(135deg,#0a0a0a,#111);
    font-family:sans-serif; color:white;
  }
  canvas{ display:block; }
  #controls{ position:absolute; top:10px; left:10px; display:flex; gap:10px; z-index:10; }
  button{ padding:8px 12px; background:#222; border:1px solid #555; color:white; cursor:pointer;}
  button:hover{ background:#444; }
  #healthBar{position:absolute; top:10px; right:10px; width:200px; height:25px; background:#333; border:2px solid #555;}
  #healthFill{width:100%; height:100%; background:#0f0;}
</style>
</head>
<body>
<div id="controls">
  <button id="startBtn">Start</button>
  <button id="stopBtn">Stop</button>
</div>
<div id="healthBar"><div id="healthFill"></div></div>
<canvas id="beatCanvas"></canvas>

<script>
const canvas=document.getElementById('beatCanvas');
const ctx=canvas.getContext('2d');
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

let shapes=[];
let pellets=[];
let animationId;
let running=false;
let bpm=120;
let beatInterval=60000/bpm;
let lastBeatTime=0;

const keys={};

// Player
const player={
  x:canvas.width/2, y:canvas.height/2,
  size:40, color:'#00f',
  speed:0.5, vx:0, vy:0, maxSpeed:6,
  health:100, dashMultiplier:3, dashCooldown:0
};

// Shape class
class Shape{
  constructor(x,y,size,type,color){
    this.x=x; this.y=y;
    this.size=size; this.type=type; this.color=color;
    this.growth=Math.random()*2+1;
    this.shootCooldown=Math.floor(Math.random()*60); // frames before first pellet
  }
  draw(){
    ctx.shadowBlur=20; ctx.shadowColor=this.color;
    ctx.fillStyle=this.color;
    ctx.beginPath();
    if(this.type==="circle") ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
    else if(this.type==="square") ctx.rect(this.x-this.size/2,this.y-this.size/2,this.size,this.size);
    else if(this.type==="triangle"){
      ctx.moveTo(this.x,this.y-this.size);
      ctx.lineTo(this.x-this.size,this.y+this.size);
      ctx.lineTo(this.x+this.size,this.y+this.size);
      ctx.closePath();
    }
    ctx.fill();
    ctx.shadowBlur=0;
  }
  update(){
    this.size+=this.growth*0.2;
    if(this.size>80 || this.size<15) this.growth*=-1;
    this.draw();

    // Shoot automatically if type is "circle" or "explosive"
    if(this.type==="circle" || this.type==="explosive"){
      this.shootCooldown--;
      if(this.shootCooldown<=0){
        this.shootAtPlayer();
        this.shootCooldown=60; // shoots every 60 frames
      }
    }
  }
  shootAtPlayer(){
    const dx=player.x-this.x;
    const dy=player.y-this.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const speed=3;
    const vx=dx/dist*speed;
    const vy=dy/dist*speed;
    pellets.push(new Pellet(this.x,this.y,vx,vy,this.color));
  }
}

// Pellet class
class Pellet{
  constructor(x,y,vx,vy,color){ this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.color=color; this.size=6; }
  update(){
    this.x+=this.vx;
    this.y+=this.vy;
    ctx.fillStyle=this.color;
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
    ctx.fill();
  }
}

// Utilities
function randomColor(){
  const r=Math.floor(Math.random()*255);
  const g=Math.floor(Math.random()*255);
  const b=Math.floor(Math.random()*255);
  return `rgb(${r},${g},${b})`;
}
function randomShapeType(){
  const types=["circle","square","triangle","explosive"];
  return types[Math.floor(Math.random()*types.length)];
}
function spawnShape(){
  const x=Math.random()*canvas.width;
  const y=Math.random()*canvas.height;
  const size=Math.random()*30+20;
  const type=randomShapeType();
  const color=randomColor();
  shapes.push(new Shape(x,y,size,type,color));
}

// Player movement
function movePlayer(){
  let ax=0, ay=0;
  if(keys['w']) ay-=player.speed;
  if(keys['s']) ay+=player.speed;
  if(keys['a']) ax-=player.speed;
  if(keys['d']) ax+=player.speed;
  if(keys['shift'] && player.dashCooldown<=0){
    ax*=player.dashMultiplier; ay*=player.dashMultiplier; player.dashCooldown=20;
  }
  player.vx+=ax; player.vy+=ay;
  player.vx*=0.85; player.vy*=0.85;
  player.vx=Math.max(-player.maxSpeed, Math.min(player.vx,player.maxSpeed));
  player.vy=Math.max(-player.maxSpeed, Math.min(player.vy,player.maxSpeed));
  player.x+=player.vx; player.y+=player.vy;
  if(player.x-player.size/2<0) player.x=player.size/2;
  if(player.x+player.size/2>canvas.width) player.x=canvas.width-player.size/2;
  if(player.y-player.size/2<0) player.y=player.size/2;
  if(player.y+player.size/2>canvas.height) player.y=canvas.height-player.size/2;
  if(player.dashCooldown>0) player.dashCooldown--;
}

// Collision detection
function checkCollisionShapePlayer(shape){
  const dx=shape.x-player.x;
  const dy=shape.y-player.y;
  const dist=Math.sqrt(dx*dx+dy*dy);
  if(shape.type==="circle") return dist<shape.size+player.size/2;
  else if(shape.type==="square") return Math.abs(shape.x-player.x)<shape.size/2+player.size/2 && Math.abs(shape.y-player.y)<shape.size/2+player.size/2;
  else if(shape.type==="triangle") return dist<shape.size+player.size/2;
  else if(shape.type==="explosive") return dist<shape.size+player.size/2;
  return false;
}
function checkCollisionPelletPlayer(p){
  const dx=p.x-player.x; const dy=p.y-player.y;
  return Math.sqrt(dx*dx+dy*dy)<p.size+player.size/2;
}

// Health bar
function updateHealthBar(){
  const fill=document.getElementById('healthFill');
  fill.style.width=player.health+'%';
  if(player.health>60) fill.style.background='#0f0';
  else if(player.health>30) fill.style.background='#ff0';
  else fill.style.background='#f00';
}

// Animate
function animate(timestamp){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Background glow
  const gradient=ctx.createRadialGradient(player.x,player.y,0,player.x,player.y,500);
  gradient.addColorStop(0,'rgba(0,0,255,0.2)');
  gradient.addColorStop(1,'rgba(0,0,0,0.1)');
  ctx.fillStyle=gradient;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(!lastBeatTime || timestamp-lastBeatTime>beatInterval){ spawnShape(); lastBeatTime=timestamp; }

  movePlayer();

  // Draw player square
  ctx.shadowBlur=20; ctx.shadowColor=player.color;
  ctx.fillStyle=player.color;
  ctx.fillRect(player.x-player.size/2,player.y-player.size/2,player.size,player.size);
  ctx.shadowBlur=0;

  // Shapes update
  shapes.forEach((shape,i)=>{
    shape.update();
    if(checkCollisionShapePlayer(shape)){ player.health-=1; if(shape.type==="explosive"){} shapes.splice(i,1); }
  });

  // Pellets update
  pellets.forEach((p,i)=>{
    p.update();
    if(checkCollisionPelletPlayer(p)){ player.health-=2; pellets.splice(i,1); }
    if(p.x<0||p.x>canvas.width||p.y<0||p.y>canvas.height) pellets.splice(i,1);
  });

  updateHealthBar();
  if(player.health<=0){ running=false; alert("Game Over!"); }

  if(running) animationId=requestAnimationFrame(animate);
}

// Events
document.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
document.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
document.getElementById('startBtn').addEventListener('click',()=>{ if(!running){ running=true; lastBeatTime=0; animate(performance.now()); } });
document.getElementById('stopBtn').addEventListener('click',()=>{ running=false; cancelAnimationFrame(animationId); });
window.addEventListener('resize',()=>{canvas.width=window.innerWidth; canvas.height=window.innerHeight;});
</script>
</body>
</html>
