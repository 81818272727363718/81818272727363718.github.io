<script>
// -----------------------------
// Basic state + helpers
// -----------------------------
let pyodide = null;
const output = document.getElementById('output');
const status = document.getElementById('status');

function appendOut(txt, cls){
  const line = document.createElement('div');
  line.textContent = txt;
  line.className = cls || 'output-line';
  output.appendChild(line);
  output.scrollTop = output.scrollHeight;
}

function clearOut(){ output.textContent = ''; }

// -----------------------------
// Initialize CodeMirror
// -----------------------------
const editor = CodeMirror(document.getElementById('editor'), {
  value: `# Hello — Python Sandbox v5\nprint('Hello, world!')`,
  mode: 'python', theme: 'dracula', lineNumbers: true, indentUnit: 4,
  extraKeys: {
    'Tab': cm => cm.replaceSelection(' '.repeat(4)),
    'Ctrl-Enter': () => runCode(),
    'Ctrl-Space': 'autocomplete'
  }
});

// -----------------------------
// Pyodide initialization
// -----------------------------
async function initPyodide(){
  status.textContent = 'Loading Pyodide...';
  pyodide = await loadPyodide();
  await pyodide.loadPackage(['micropip']);
  pyodide.globals.set('appendOut', text => appendOut(text));
  pyodide.globals.set('getInput', () => prompt('Input:') || '');

  await pyodide.runPythonAsync(`
import sys
from pyodide.ffi import create_proxy
appendOut = create_proxy(appendOut)
getInput = create_proxy(getInput)
class JSWriter:
    def write(self,s):
        if s and str(s).strip(): appendOut(str(s))
    def flush(self): pass
sys.stdout = JSWriter()
sys.stderr = JSWriter()
import builtins
builtins.input = lambda prompt='': getInput()
  `);
  status.textContent = 'Ready';
  output.textContent = 'Pyodide loaded. Use Run to execute the code.\n';
}
initPyodide();

// -----------------------------
// Run code
// -----------------------------
async function runCode(code){
  if(!pyodide) return;
  clearOut();
  status.textContent = 'Running...';
  try{
    const src = code || editor.getValue();
    const result = await pyodide.runPythonAsync(src);
    if(result !== undefined) appendOut(String(result));
  } catch(err){ appendOut(err.toString(), 'output-err'); }
  status.textContent = 'Ready';
}

document.getElementById('run').addEventListener('click', ()=> runCode());
document.getElementById('runSel').addEventListener('click', ()=> {
  const sel = editor.getSelection(); runCode(sel || editor.getValue());
});

// -----------------------------
// Format with black
// -----------------------------
document.getElementById('format').addEventListener('click', async ()=>{
  if(!pyodide) return;
  status.textContent = 'Formatting...';
  try{
    await pyodide.runPythonAsync(`import micropip; await micropip.install('black')`);
    const code = editor.getValue();
    const formatted = await pyodide.runPythonAsync(`from black import format_str, FileMode\nformat_str('''${code.replace(/`/g,'`')}''' , mode=FileMode())`);
    editor.setValue(formatted);
  } catch(e){ appendOut('Formatter error: '+e, 'output-err'); }
  status.textContent = 'Ready';
});

// -----------------------------
// Install packages
// -----------------------------
document.getElementById('loadPkg').addEventListener('click', async ()=>{
  const pkg = prompt('Enter package name to install (PyPI):');
  if(!pkg) return;
  status.textContent = 'Installing...';
  try{
    await pyodide.runPythonAsync(`import micropip; await micropip.install('${pkg}')`);
    appendOut(`✅ Package ${pkg} installed`);
  } catch(e){ appendOut('❌ Failed: '+e, 'output-err'); }
  status.textContent = 'Ready';
});

// -----------------------------
// File open / save
// -----------------------------
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  file.text().then(txt=> editor.setValue(txt));
});

document.getElementById('openBtn').addEventListener('click', ()=> fileInput.click());
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const blob = new Blob([editor.getValue()],{type:'text/plain'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'script.py'; a.click();
});

document.getElementById('openFileBtn').addEventListener('click', ()=> fileInput.click());
document.getElementById('saveFileBtn').addEventListener('click', ()=> document.getElementById('saveBtn').click());

// -----------------------------
// Clear output
// -----------------------------
document.getElementById('clearOut').addEventListener('click', clearOut);

// -----------------------------
// Splitter (resizable panels)
const splitter = document.getElementById('splitter');
const leftPanel = document.getElementById('leftPanel');
const workspace = document.querySelector('.workspace');
let dragging = false;
splitter.addEventListener('mousedown', e=>{ dragging = true; document.body.style.cursor='col-resize'; });
window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.cursor=''; });
window.addEventListener('mousemove', e=>{
  if(!dragging) return;
  const rect = workspace.getBoundingClientRect();
  const px = Math.max(240, Math.min(e.clientX - rect.left, rect.width - 200));
  workspace.style.gridTemplateColumns = px+'px 12px 1fr';
  editor.refresh && editor.refresh();
});

// -----------------------------
// Header toggle
const header = document.getElementById('mainHeader');
let headerHidden = false;
document.getElementById('toggleHeader').addEventListener('click', ()=>{
  headerHidden = !headerHidden;
  if(headerHidden){ header.classList.add('collapsed'); document.getElementById('toggleHeader').textContent = 'Show Top'; }
  else { header.classList.remove('collapsed'); document.getElementById('toggleHeader').textContent = 'Hide Top'; }
});

// -----------------------------
// Accent color customizer
const accentPicker = document.getElementById('accentPicker');
const accentVal = document.getElementById('accentVal');
const customizer = document.getElementById('customizer');

function hexToRgb(hex){ const v = hex.replace('#',''); return { r: parseInt(v.substring(0,2),16), g: parseInt(v.substring(2,4),16), b: parseInt(v.substring(4,6),16) }; }
function applyAccent(){
  const hex = accentPicker.value;
  const rgb = hexToRgb(hex);
  const intensity = parseInt(accentVal.value);
  const scale = intensity/160;
  const r = Math.max(0, Math.min(255, Math.round(rgb.r * scale)));
  const g = Math.max(0, Math.min(255, Math.round(rgb.g * scale)));
  const b = Math.max(0, Math.min(255, Math.round(rgb.b * scale)));
  document.documentElement.style.setProperty('--accent', `${r}, ${g}, ${b}`);
  document.documentElement.style.setProperty('--accent-hex', hex);
}
accentPicker.addEventListener('input', applyAccent);
accentVal.addEventListener('input', applyAccent);
document.getElementById('resetAccent').addEventListener('click', ()=>{ accentPicker.value = '#A050FF'; accentVal.value = 160; applyAccent(); });
document.getElementById('toggleCustomizer').addEventListener('click', ()=>{ customizer.style.display = 'none'; });

// -----------------------------
// Focus glow for panels
leftPanel.addEventListener('mouseenter', ()=>{ leftPanel.classList.add('focused'); rightPanel.classList.remove('focused'); });
const rightPanel = document.getElementById('rightPanel');
rightPanel.addEventListener('mouseenter', ()=>{ rightPanel.classList.add('focused'); leftPanel.classList.remove('focused'); });
new ResizeObserver(()=> editor.refresh && editor.refresh()).observe(leftPanel);

// -----------------------------
// Accessibility
window.addEventListener('keydown', e=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); document.getElementById('saveBtn').click(); }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='o'){ e.preventDefault(); fileInput.click(); }
});

// initial accent
applyAccent();
appendOut('Tip: use the color picker bottom-right to change the accent color.');
</script>
