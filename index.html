<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Python Sandbox v5 — Floating Panels + ChatGPT</title>

<!-- Pyodide -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

<!-- CodeMirror 5 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/python-hint.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.css">

<style>
:root{
  --bg-1: #081123;
  --accent: 160, 80, 255;
  --glass-blur: 12px;
  --accent-hex: #A050FF;
}
html,body{height:100%;margin:0;font-family:Inter, sans-serif;background:linear-gradient(180deg,var(--bg-1),#02030a);color:#e9eef8;overflow:hidden}

/* Floating panel common style */
.fpanel{
  position:absolute;background:rgba(255,255,255,0.03);backdrop-filter:blur(var(--glass-blur));border:1px solid rgba(255,255,255,0.05);border-radius:12px;padding:12px;box-shadow:0 12px 40px rgba(0,0,0,0.6);overflow:hidden;cursor:move;
}
.fpanel .header{font-weight:600;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.fpanel .closeBtn{cursor:pointer;font-weight:bold;color:var(--accent-hex)}
.fpanel pre{background:transparent;overflow:auto;height:calc(100% - 32px);white-space:pre-wrap}

/* Main output panel */
#outputPanel{width:48%;height:60%;right:4%;bottom:4%}
#outputPanel pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Courier New,monospace;font-size:14px}

/* Tabbed Editor */
#editorPanel{width:48%;height:60%;left:4%;bottom:4%}
.CodeMirror{height:100%;border-radius:8px}
.tabBar{display:flex;gap:6px;margin-bottom:6px}
.tabBar .tab{padding:4px 10px;border-radius:6px;background:rgba(255,255,255,0.02);cursor:pointer;transition:0.2s}
.tabBar .tab.active{background:rgba(var(--accent),0.12);color:#fff;font-weight:600}

/* File Explorer */
#fileExplorer{width:220px;height:320px;top:10%;left:2%}
#fileExplorer ul{list-style:none;padding:0;margin:0;max-height:250px;overflow:auto}
#fileExplorer li{padding:4px 6px;border-radius:6px;cursor:pointer}
#fileExplorer li:hover{background:rgba(var(--accent),0.12)}
#fileExplorer input{width:100%;margin-top:6px;padding:4px;border-radius:6px;border:none}

/* Variable Inspector modal */
#varInspector{width:320px;height:360px;top:20%;right:10%;display:none;flex-direction:column}
#varInspector h4{margin:0 0 8px 0;font-size:14px}
#varInspector pre{flex:1;overflow:auto}
#varInspector .closeBtn{cursor:pointer;align-self:flex-end;font-weight:bold;color:var(--accent-hex)}

/* Discord Webhook panel */
#discordPanel{width:280px;height:120px;top:5%;right:4%;display:none;flex-direction:column}
#discordPanel label,input{margin:2px 0}

/* ChatGPT panel */
#chatPanel{width:360px;height:400px;top:10%;right:2%;display:none;flex-direction:column}
#chatPanel textarea{width:100%;height:100px;border-radius:6px;padding:6px;margin-bottom:6px;background:rgba(255,255,255,0.05);border:none;color:#fff}
#chatPanel pre{flex:1;overflow:auto;background:rgba(255,255,255,0.03);border-radius:6px;padding:6px;white-space:pre-wrap;}

/* Floating buttons */
.floatingBtn{position:fixed;bottom:12px;left:12px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);cursor:pointer;transition:0.2s}
.floatingBtn:hover{transform:translateY(-3px)}
</style>
</head>
<body>

<!-- Editor Panel -->
<div class="fpanel" id="editorPanel">
  <div class="header">Editor <span class="closeBtn" onclick="editorPanel.style.display='none'">✖</span></div>
  <div class="tabBar" id="tabBar"></div>
  <div id="editor"></div>
</div>

<!-- Output Panel -->
<div class="fpanel" id="outputPanel">
  <div class="header">Output <span class="closeBtn" onclick="outputPanel.style.display='none'">✖</span></div>
  <pre id="output">Loading Pyodide...</pre>
</div>

<!-- ChatGPT Panel -->
<div class="fpanel" id="chatPanel">
  <div class="header">ChatGPT <span class="closeBtn" onclick="chatPanel.style.display='none'">✖</span></div>
  <textarea id="chatInput" placeholder="Ask ChatGPT..."></textarea>
  <button onclick="sendChat()">Send</button>
  <pre id="chatOutput"></pre>
</div>

<!-- File Explorer -->
<div class="fpanel" id="fileExplorer">
  <div class="header">Files <span class="closeBtn" onclick="fileExplorer.style.display='none'">✖</span></div>
  <ul id="fileList"></ul>
  <input type="text" id="newFileName" placeholder="New file name">
  <button onclick="createFile()">Create</button>
</div>

<!-- Variable Inspector -->
<div class="fpanel" id="varInspector" style="display:none;flex">
  <div class="header">Variables <span class="closeBtn" onclick="varInspector.style.display='none'">✖</span></div>
  <pre id="varsOut">Variables will appear here</pre>
</div>

<!-- Discord Webhook Panel -->
<div class="fpanel" id="discordPanel" style="display:none;flex">
  <div class="header">Discord Webhook <span class="closeBtn" onclick="discordPanel.style.display='none'">✖</span></div>
  <label>Webhook URL:</label>
  <input type="text" id="webhookURL" placeholder="https://discord.com/api/webhooks/...">
  <label><input type="checkbox" id="discordToggle"> Enable logging</label>
</div>

<!-- Floating Buttons -->
<button class="floatingBtn" onclick="editorPanel.style.display='flex'">Editor</button>
<button class="floatingBtn" style="left:120px" onclick="outputPanel.style.display='flex'">Output</button>
<button class="floatingBtn" style="left:230px" onclick="fileExplorer.style.display='flex'">Files</button>
<button class="floatingBtn" style="left:350px" onclick="varInspector.style.display='flex'">Variables</button>
<button class="floatingBtn" style="left:480px" onclick="discordPanel.style.display='flex'">Discord</button>
<button class="floatingBtn" style="left:600px" onclick="chatPanel.style.display='flex'">ChatGPT</button>

<script>
// -----------------------------
// CodeMirror
// -----------------------------
const editor = CodeMirror(document.getElementById('editor'), {
  value: `# Floating Panels Python Sandbox\nprint('Hello World')`,
  mode:'python',theme:'dracula',lineNumbers:true,indentUnit:4,
  extraKeys:{'Tab':cm=>cm.replaceSelection(' '.repeat(4)),'Ctrl-Enter':()=>runCode(),'Ctrl-Space':'autocomplete'}
});

// -----------------------------
// File Tabs
// -----------------------------
let files = {}, currentFile = 'main.py';
function createFile(){
  const name = document.getElementById('newFileName').value.trim();
  if(!name) return;
  files[name]='';
  updateFileList();
}
function updateFileList(){
  const ul = document.getElementById('fileList'); ul.innerHTML='';
  for(let f in files){
    const li=document.createElement('li'); li.textContent=f; li.onclick=()=>{ loadFile(f); }; ul.appendChild(li);
  }
  updateTabs();
}
function loadFile(name){
  saveCurrentFile(); currentFile=name; editor.setValue(files[name]); updateTabs();
}
function saveCurrentFile(){ files[currentFile]=editor.getValue(); }
function updateTabs(){
  const tabBar=document.getElementById('tabBar'); tabBar.innerHTML='';
  for(let f in files){
    const t=document.createElement('div'); t.className='tab'+(f===currentFile?' active':''); t.textContent=f; t.onclick=()=>loadFile(f); tabBar.appendChild(t);
  }
}
files[currentFile]=''; updateFileList();

// -----------------------------
// Pyodide Init
// -----------------------------
let pyodide=null;
const output=document.getElementById('output');
const varsOut=document.getElementById('varsOut');
async function initPyodide(){
  output.textContent='Loading Pyodide...';
  pyodide=await loadPyodide();
  await pyodide.loadPackage(['micropip']);
  pyodide.globals.set('appendOut', txt=>{ output.textContent+=txt+'\n'; });
  pyodide.globals.set('getInput', ()=>prompt('Input:')||'');
  await pyodide.runPythonAsync(`
import sys
from pyodide.ffi import create_proxy
appendOut=create_proxy(appendOut)
getInput=create_proxy(getInput)
class JSWriter:
    def write(self,s):
        if s and str(s).strip(): appendOut(str(s))
    def flush(self): pass
sys.stdout=JSWriter()
sys.stderr=JSWriter()
import builtins
builtins.input=lambda prompt='':getInput()
  `);
  output.textContent='Pyodide loaded.\n';
}
initPyodide();

// -----------------------------
// Run code + Variables
// -----------------------------
async function runCode(){
  saveCurrentFile(); output.textContent=''; varsOut.textContent='';
  try{
    await pyodide.runPythonAsync(editor.getValue());
    const vars=await pyodide.runPythonAsync(`{k:v for k,v in globals().items() if not k.startswith('_') and k not in ['sys','appendOut','getInput','JSWriter','builtins']}`);
    window.varsSnapshot=vars;
  }catch(e){ output.textContent+=e+'\n'; }
}
window.showVars=()=>{ if(window.varsSnapshot){ varsOut.textContent=JSON.stringify(window.varsSnapshot,null,2); varInspector.style.display='flex'; } }

// -----------------------------
// ChatGPT Integration
// -----------------------------
let chatApiKey = '';
async function sendChat(){
  if(!chatApiKey){
    chatApiKey = prompt("Enter your OpenAI API Key (sk-...)");
    if(!chatApiKey) return;
  }
  const input = document.getElementById('chatInput').value.trim();
  if(!input) return;
  const out = document.getElementById('chatOutput');
  out.textContent += "> " + input + "\n";
  try{
    const resp = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+chatApiKey
      },
      body:JSON.stringify({
        model:"gpt-3.5-turbo",
        messages:[{role:"user", content:input}],
        temperature:0.7
      })
    });
    const data = await resp.json();
    const msg = data.choices?.[0]?.message?.content || "[No response]";
    out.textContent += msg + "\n\n";
    out.scrollTop = out.scrollHeight;
  }catch(e){
    out.textContent += "[Error] "+e+"\n\n";
  }
}
</script>
</body>
</html>
