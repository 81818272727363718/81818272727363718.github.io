<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash Royale Clone (Enhanced)</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #333;
            margin: 0;
            height: 100vh;
            font-family: sans-serif;
        }
        #game-container {
            width: 800px;
            height: 600px;
            background-color: #4CAF50;
            position: relative;
            border: 2px solid #000;
            overflow: hidden;
        }
        #river {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 40px;
            background-color: #2196F3;
            transform: translateY(-50%);
            border-top: 2px solid #000;
            border-bottom: 2px solid #000;
        }
        #ui-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background-color: #555;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .card-slot {
            width: 70px;
            height: 90px;
            background-color: #eee;
            border: 2px solid #000;
            cursor: pointer;
            text-align: center;
            padding-top: 5px;
            box-sizing: border-box;
            user-select: none;
            position: relative;
        }
        .card-slot:hover:not(.disabled) {
            background-color: #fff;
        }
        .card-slot.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .elixir-cost {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
        }
        .troop, .tower {
            position: absolute;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }
        .troop {
             width: 30px;
            height: 40px;
            border-radius: 50%;
        }
        .tower {
            width: 60px;
            height: 80px;
            background-color: grey;
            border: 2px solid black;
        }
        .tower.player { background-color: lightblue; border-color: blue; }
        .tower.enemy { background-color: lightcoral; border-color: red; }

        .health-bar {
            width: 100%;
            height: 5px;
            background-color: grey;
            margin-bottom: 2px;
        }
        .health-bar-inner {
            height: 100%;
            background-color: green;
        }
        #elixir-bar-container {
            position: absolute;
            bottom: 110px;
            left: 20px;
            width: 200px;
            height: 20px;
            background-color: black;
            border: 2px solid white;
        }
        #elixir-bar {
            height: 100%;
            width: 0%;
            background-color: purple;
            transition: width 0.1s linear;
        }
        #elixir-count {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
        }
        #game-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            color: white;
            text-shadow: 2px 2px 4px #000000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="river"></div>
        <div id="game-message"></div>
        
        <div id="elixir-bar-container">
            <div id="elixir-bar"></div>
            <span id="elixir-count">0 / 10</span>
        </div>

        <!-- Troops and Towers will be spawned dynamically by JS -->
        <div id="ui-bar">
            <!-- Cards with cost display -->
            <div id="card-1" class="card-slot" onclick="deployTroop(1)">
                Knight <span class="elixir-cost">3</span>
            </div>
            <div id="card-2" class="card-slot" onclick="deployTroop(2)">
                Archer <span class="elixir-cost">4</span>
            </div>
            <div id="card-3" class="card-slot" onclick="deployTroop(3)">
                Giant <span class="elixir-cost">5</span>
            </div>
        </div>
    </div>
    
    <script>
        const gameContainer = document.getElementById('game-container');
        const elixirBar = document.getElementById('elixir-bar');
        const elixirCountEl = document.getElementById('elixir-count');
        const gameMessageEl = document.getElementById('game-message');
        const arenaHeight = 500;
        const playerBaseY = arenaHeight - 50;
        const enemyBaseY = 50;
        const TROOP_RADIUS = 15; // Width/2 of the troop element

        let troopId = 0;
        const activeUnits = [];
        let playerElixir = 0;
        const MAX_ELIXIR = 10;
        const ELIXIR_RATE = 1000; // 1 Elixir per second

        const TROOP_STATS = {
            1: { name: 'Knight', hp: 100, speed: 2, cost: 3, dmg: 15, range: 40, color: 'blue' },
            2: { name: 'Archer', hp: 50, speed: 3, cost: 4, dmg: 10, range: 150, color: 'lightblue' },
            3: { name: 'Giant', hp: 200, speed: 1, cost: 5, dmg: 25, range: 40, color: 'darkblue' },
        };

        // --- Elixir System ---
        function updateElixir(amount) {
            playerElixir = Math.min(MAX_ELIXIR, playerElixir + amount);
            elixirBar.style.width = `${(playerElixir / MAX_ELIXIR) * 100}%`;
            elixirCountEl.textContent = `${Math.floor(playerElixir)} / ${MAX_ELIXIR}`;
            updateCardAvailability();
        }
        setInterval(() => updateElixir(1), ELIXIR_RATE);

        function updateCardAvailability() {
            Object.keys(TROOP_STATS).forEach(type => {
                const cardEl = document.getElementById(`card-${type}`);
                if (playerElixir >= TROOP_STATS[type].cost) {
                    cardEl.classList.remove('disabled');
                } else {
                    cardEl.classList.add('disabled');
                }
            });
        }

        // --- Troop/Tower Creation ---
        function createHealthBar(unitData) {
            const healthBar = document.createElement('div');
            healthBar.classList.add('health-bar');
            const healthBarInner = document.createElement('div');
            healthBarInner.classList.add('health-bar-inner');
            healthBar.appendChild(healthBarInner);
            unitData.healthBar = healthBarInner;
            return healthBar;
        }

        function createUnit(type, isPlayer, x, y, isTower = false) {
            const stats = isTower ? { hp: 500, maxHp: 500, dmg: 30, range: 200, speed: 0 } : TROOP_STATS[type];
            const unitEl = document.createElement('div');
            unitEl.classList.add(isTower ? 'tower' : 'troop');
            unitEl.classList.add(isPlayer ? 'player' : 'enemy');
            if (!isTower) unitEl.style.backgroundColor = stats.color;
            unitEl.style.left = `${x}px`;
            unitEl.style.top = `${y}px`;

            const unitData = {
                id: troopId++,
                type: type,
                element: unitEl,
                x: x,
                y: y,
                hp: stats.hp,
                maxHp: stats.hp,
                speed: stats.speed,
                dmg: stats.dmg,
                range: stats.range,
                isPlayer: isPlayer,
                isTower: isTower,
                target: null,
                attackCooldown: 0,
            };
            
            unitEl.appendChild(createHealthBar(unitData));
            activeUnits.push(unitData);
            gameContainer.appendChild(unitEl);
            return unitData;
        }

        window.deployTroop = function(type) {
            const stats = TROOP_STATS[type];
            if (playerElixir >= stats.cost) {
                // Deploy in the player's half, randomly along the back
                const startX = Math.random() * (gameContainer.clientWidth - 40) + 20;
                const startY = Math.random() * (arenaHeight / 2 - 100) + (arenaHeight / 2 + 50);
                createUnit(type, true, startX, startY);
                updateElixir(-stats.cost);
            }
        }

        // --- Game Logic ---

        function getDistance(unit1, unit2) {
            const dx = unit1.x - unit2.x;
            const dy = unit1.y - unit2.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function findTarget(unit) {
            let closestTarget = null;
            let minDist = Infinity;

            for (const otherUnit of activeUnits) {
                if (unit.isPlayer !== otherUnit.isPlayer) { // Target enemies
                    const dist = getDistance(unit, otherUnit);
                    if (dist < minDist) {
                        minDist = dist;
                        closestTarget = otherUnit;
                    }
                }
            }
            unit.target = closestTarget;
        }

        function handleCombat(unit) {
            if (!unit.target || unit.target.hp <= 0) {
                findTarget(unit);
                return;
            }

            const distanceToTarget = getDistance(unit, unit.target);

            if (distanceToTarget <= unit.range) {
                // Stop moving and attack
                unit.attackCooldown -= 16; // Roughly 16ms per frame
                if (unit.attackCooldown <= 0) {
                    unit.target.hp -= unit.dmg;
                    unit.attackCooldown = 1000; // Attack every 1 second
                    // Update target health bar visually
                    const hpPercent = (unit.target.hp / unit.target.maxHp) * 100;
                    unit.target.healthBar.style.width = `${Math.max(0, hpPercent)}%`;
                }
            } else if (!unit.isTower) {
                // Move towards target if out of range and not a tower
                const angle = Math.atan2(unit.target.y - unit.y, unit.target.x - unit.x);
                unit.x += Math.cos(angle) * unit.speed;
                unit.y += Math.sin(angle) * unit.speed;
            }
        }

        function checkWinLoss() {
            const playerTowers = activeUnits.filter(u => u.isTower && u.isPlayer && u.hp > 0);
            const enemyTowers = activeUnits.filter(u => u.isTower && !u.isPlayer && u.hp > 0);

            if (enemyTowers.length === 0) {
                gameMessageEl.textContent = "YOU WIN! ðŸŽ‰";
                gameMessageEl.style.display = 'block';
                return true;
            } else if (playerTowers.length === 0) {
                gameMessageEl.textContent = "YOU LOSE! ðŸ’€";
                gameMessageEl.style.display = 'block';
                return true;
            }
            return false;
        }

        function updateGame() {
            if (checkWinLoss()) return; // Stop game loop on win/loss

            // Filter out destroyed units and update positions/combat
            for (let i = activeUnits.length - 1; i >= 0; i--) {
                const unit = activeUnits[i];
                if (unit.hp <= 0) {
                    unit.element.remove();
                    activeUnits.splice(i, 1);
                    continue;
                }

                handleCombat(unit);

                // Update DOM position for moving units
                if (unit.speed > 0) {
                    unit.element.style.left = `${unit.x - TROOP_RADIUS}px`;
                    unit.element.style.top = `${unit.y - TROOP_RADIUS}px`;
                }
            }

            requestAnimationFrame(updateGame);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', (event) => {
            // Spawn player towers (centered X position)
            createUnit(null, true, gameContainer.clientWidth / 2, arenaHeight - 120, true);
            // Spawn enemy towers
            createUnit(null, false, gameContainer.clientWidth / 2, 40, true);
            
            // Initial Elixir update
            updateElixir(0); 

            // Start the game loop
            requestAnimationFrame(updateGame);
        });
    </script>
</body>
</html>
